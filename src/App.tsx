import React, { useState, useEffect } from 'react';
import { ChevronLeft, ChevronRight, Loader2 } from 'lucide-react';
import StepIndicator from './components/StepIndicator';
import JobTypeSelection from './components/JobTypeSelection';
import BusinessChallengeForm from './components/BusinessChallengeForm';
import AIQuestionsForm from './components/AIQuestionsForm';
import PersonalInfoForm from './components/PersonalInfoForm';
import ResultsDisplay from './components/ResultsDisplay';
import AnalysisLoading from './components/AnalysisLoading';
import SimpleAnalysisLoading from './components/SimpleAnalysisLoading';
import TermsAgreement from './components/TermsAgreement';
import { submitDiagnosis, getCurrentWebhookUrl, getCurrentTenant } from './utils/difyApi';
import { useWebhookReceiver } from './hooks/useWebhookReceiver';
import { FormData } from './types';

const STORAGE_KEY = 'ai-diagnosis-form-data';

function App() {
  const [currentStep, setCurrentStep] = useState(1);
  const [isLoading, setIsLoading] = useState(false);
  const [results, setResults] = useState<any>(null);
  const [errors, setErrors] = useState<Record<string, string>>({});

  // WebhookÂèó‰ø°„Éï„ÉÉ„ÇØ
  const { 
    webhookResult, 
    isWaitingForWebhook, 
    startWaitingForWebhook, 
    clearWebhookResult,
    getWebhookUrl,
    setIsWaitingForWebhook
  } = useWebhookReceiver();

  const [formData, setFormData] = useState<Partial<FormData>>({
    jobType: '',
    BusinessChallenge1: '',
    BusinessChallenge2: '',
    BusinessChallenge3: '',
    Q1: null, Q2: null, Q3: null, Q4: null, Q5: null, Q6: null, Q7: null, Q8: null, Q9: null, Q10: null,
    Q36: '', Q37: '', Q38: '', Q39: '', Q40: '',
    name: '',
    company: '',
    Yuryo: '',
    Muryo: '',
    Katsuyou: ''
  });

  const [agreedToTerms, setAgreedToTerms] = useState(false);
  const [showTermsStep, setShowTermsStep] = useState(true);

  // WebhookÁµêÊûú„ÇíÁõ£Ë¶ñÔºàÊúÄÂÑ™ÂÖàÔºâ
  useEffect(() => {
    if (webhookResult) {
      console.log('üéØ Webhook result received in App (PRIORITY):', webhookResult);
      console.log('üéØ Webhook result type:', typeof webhookResult);
      console.log('üéØ Webhook result keys:', Object.keys(webhookResult));
      
      // Webhook„ÅÆÁµêÊûú„ÇíÊúÄÂÑ™ÂÖà„Åß‰ΩøÁî®
      setResults(webhookResult);
      setCurrentStep(5);
      setIsLoading(false);
      setIsWaitingForWebhook(false);
      localStorage.removeItem(STORAGE_KEY);
      
      console.log('‚úÖ Webhook result processed successfully');
    }
  }, [webhookResult]);

  // LocalStorage„ÇíÁõ¥Êé•Áõ£Ë¶ñÔºàËøΩÂä†„ÅÆÂÆâÂÖ®Á≠ñÔºâ
  useEffect(() => {
    if (isWaitingForWebhook) {
      console.log('üîç Starting aggressive polling for webhook result...');
      
      const checkInterval = setInterval(() => {
        const stored = localStorage.getItem('dify_webhook_result');
        if (stored) {
          try {
            const parsed = JSON.parse(stored);
            console.log('üéØ Direct LocalStorage check found result:', parsed);
            setResults(parsed);
            setCurrentStep(5);
            setIsLoading(false);
            setIsWaitingForWebhook(false);
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem('dify_webhook_result');
          } catch (error) {
            console.error('Error parsing stored result:', error);
          }
        }
      }, 500); // 0.5Áßí„Åî„Å®„Å´„ÉÅ„Çß„ÉÉ„ÇØÔºà„Çà„ÇäÈ†ªÁπÅ„Å´Ôºâ

      // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„Éè„É≥„Éâ„É™„É≥„Ç∞
      const timeoutCheck = setTimeout(() => {
        console.log('‚è∞ Webhook timeout reached, checking for any stored results...');
        const stored = localStorage.getItem('dify_webhook_result');
        if (stored) {
          try {
            const parsed = JSON.parse(stored);
            console.log('üéØ Found result during timeout check:', parsed);
            setResults(parsed);
            setCurrentStep(5);
            setIsLoading(false);
            setIsWaitingForWebhook(false);
            localStorage.removeItem('dify_webhook_result');
          } catch (error) {
            console.error('Error parsing timeout result:', error);
          }
        }
      }, 30000); // 30Áßí„Åß„Çø„Ç§„É†„Ç¢„Ç¶„Éà

      return () => {
        clearInterval(checkInterval);
        clearTimeout(timeoutCheck);
      };
    }
  }, [isWaitingForWebhook]);

  // Local Storage „Åã„Çâ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
  useEffect(() => {
    const savedData = localStorage.getItem(STORAGE_KEY);
    if (savedData) {
      try {
        const parsed = JSON.parse(savedData);
        setFormData(prev => ({ ...prev, ...parsed }));
      } catch (error) {
        console.error('Failed to load saved data:', error);
      }
    }

    // WebhookÁµêÊûú„ÅÆÂç≥Â∫ß„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç¢„Éó„É™Ëµ∑ÂãïÊôÇÔºâ
    const checkWebhookResult = () => {
      const webhookData = localStorage.getItem('dify_webhook_result');
      if (webhookData) {
        try {
          const parsed = JSON.parse(webhookData);
          console.log('üöÄ Found webhook result on app start:', parsed);
          setResults(parsed);
          setCurrentStep(5);
          setIsLoading(false);
          localStorage.removeItem('dify_webhook_result');
          localStorage.removeItem(STORAGE_KEY);
        } catch (error) {
          console.error('Error parsing webhook result on start:', error);
        }
      }
    };

    checkWebhookResult();

    // „Éö„Éº„Ç∏„Éï„Ç©„Éº„Ç´„ÇπÊôÇ„ÅÆËá™Âãï„ÉÅ„Çß„ÉÉ„ÇØ
    const handleFocus = () => {
      console.log('üîç Page focused, checking for webhook results...');
      checkWebhookResult();
    };

    window.addEventListener('focus', handleFocus);
    return () => window.removeEventListener('focus', handleFocus);
  }, []);

  // URL „Éë„É©„É°„Éº„Çø„Åã„ÇâWebhook „Éá„Éº„Çø„ÇíÂèó‰ø°Ôºà„Ç∑„É≥„Éó„É´ÂΩ¢ÂºèÔºâ
  useEffect(() => {
    console.log('üîç Checking URL parameters on mount...');
    const urlParams = new URLSearchParams(window.location.search);
    const stepParam = urlParams.get('step');
    const webhookDataParam = urlParams.get('webhook_data');
    const resultParam = urlParams.get('result');
    const webhookParam = urlParams.get('webhook');
    const dataParam = urlParams.get('data');
    
    console.log('üîç URL Parameters:', {
      step: stepParam,
      webhook_data: webhookDataParam ? 'present' : 'missing',
      result: resultParam ? 'present' : 'missing',
      webhook: webhookParam,
      data: dataParam ? 'present' : 'missing'
    });
    
    // ÊúÄÊñ∞„ÅÆ„Ç∑„É≥„Éó„É´ÂΩ¢Âºè: ?step=5&webhook_data=...
    if (stepParam === '5' && webhookDataParam) {
      console.log('üéØ Processing simple webhook data from URL...');
      try {
        const webhookData = JSON.parse(decodeURIComponent(webhookDataParam));
        console.log('üéØ Simple webhook data from URL:', webhookData);
        
        // Convert raw webhook data to expected format
        const processedResult = {
          workflow_run_id: webhookData.workflow_run_id || `webhook_${Date.now()}`,
          task_id: webhookData.workflow_run_id || `task_${Date.now()}`,
          data: {
            id: webhookData.workflow_run_id || `result_${Date.now()}`,
            workflow_id: webhookData.workflow_run_id || '',
            status: 'succeeded',
            outputs: {
              result: webhookData.result || webhookData.output || JSON.stringify(webhookData)
            },
            elapsed_time: 2000,
            total_tokens: 800,
            total_steps: 1,
            created_at: Date.now(),
            finished_at: Date.now()
          }
        };
        
        console.log('‚úÖ Setting results and transitioning to step 5:', processedResult);
        setResults(processedResult);
        setCurrentStep(5);
        setIsLoading(false);
        setIsWaitingForWebhook(false);
        localStorage.removeItem(STORAGE_KEY);
        
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
        return;
      } catch (error) {
        console.error('‚ùå Failed to parse simple webhook data from URL:', error);
      }
    } else if (stepParam === '5') {
      console.log('üéØ Step 5 requested but no webhook data, going to step 5 anyway');
      setCurrentStep(5);
      setIsLoading(false);
      setIsWaitingForWebhook(false);
    }
    
    // ‰∏≠ÈñìÂΩ¢Âºè: ?step=5&result=...
    if (stepParam === '5' && resultParam) {
      try {
        const resultData = JSON.parse(decodeURIComponent(resultParam));
        console.log('üéØ Direct webhook result from URL:', resultData);
        
        setResults(resultData);
        setCurrentStep(5);
        setIsLoading(false);
        setIsWaitingForWebhook(false);
        localStorage.removeItem(STORAGE_KEY);
        
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
        return;
      } catch (error) {
        console.error('Failed to parse direct webhook result from URL:', error);
      }
    }
    
    // ÊóßÂΩ¢Âºè„ÅÆ„Çµ„Éù„Éº„Éà: ?webhook=received&data=...
    if (webhookParam === 'received' && dataParam) {
      try {
        const webhookData = JSON.parse(decodeURIComponent(dataParam));
        console.log('üéØ Legacy webhook data from URL:', webhookData);
        
        // Process the webhook data
        const processedResult = {
          workflow_run_id: webhookData.workflow_run_id || `webhook_${Date.now()}`,
          task_id: webhookData.data?.id || `task_${Date.now()}`,
          data: {
            id: webhookData.data?.id || `result_${Date.now()}`,
            workflow_id: webhookData.data?.workflow_id || webhookData.workflow_run_id || '',
            status: webhookData.data?.status || 'succeeded',
            outputs: webhookData.data?.outputs || { 
              result: webhookData.result || webhookData.text || JSON.stringify(webhookData)
            },
            error: webhookData.data?.error,
            elapsed_time: webhookData.data?.elapsed_time || 0,
            total_tokens: webhookData.data?.total_tokens || 0,
            total_steps: webhookData.data?.total_steps || 0,
            created_at: webhookData.data?.created_at || Date.now(),
            finished_at: webhookData.data?.finished_at || Date.now()
          }
        };
        
        setResults(processedResult);
        setCurrentStep(5);
        setIsLoading(false);
        setIsWaitingForWebhook(false);
        localStorage.removeItem(STORAGE_KEY);
        
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
      } catch (error) {
        console.error('Failed to parse legacy webhook data from URL:', error);
      }
    }
  }, []);

  // „Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Çâ Local Storage „Å´‰øùÂ≠ò
  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
  }, [formData]);

  const updateFormData = (field: string, value: string | number) => {
    setFormData(prev => ({ ...prev, [field]: value }));
    // „Ç®„É©„Éº„Çí„ÇØ„É™„Ç¢
    if (errors[field]) {
      setErrors(prev => ({ ...prev, [field]: '' }));
    }
  };

  const validateStep = (step: number): boolean => {
    const newErrors: Record<string, string> = {};

    switch (step) {
      case 1:
        if (!formData.jobType) {
          newErrors.jobType = 'ËÅ∑Á®Æ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        }
        break;
      case 2:
        if (!formData.BusinessChallenge1) {
          newErrors.BusinessChallenge1 = 'ÊúÄ„ÇÇÊôÇÈñì„Åå„Åã„Åã„Å£„Å¶„ÅÑ„ÇãÊ•≠ÂãôË™≤È°å„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        }
        break;
      case 3:
        // Q1-Q35„ÅÆÊï∞ÂÄ§Ë≥™Âïè„ÅÆÊ§úË®ºÔºà„Åô„Åπ„Å¶ÂøÖÈ†àÔºâ
        for (let i = 1; i <= 35; i++) {
          const key = `Q${i}` as keyof FormData;
          if (!formData[key] || formData[key] === null) {
            newErrors[key] = `Q${i}„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
            break; // ÊúÄÂàù„ÅÆ„Ç®„É©„Éº„ÅÆ„ÅøË°®Á§∫
          }
        }
        break;
      case 4:
        if (!formData.name?.trim()) {
          newErrors.name = 'ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        }
        if (!formData.company?.trim()) {
          newErrors.company = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        }
        break;
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleNext = () => {
    if (validateStep(currentStep)) {
      setCurrentStep(prev => Math.min(prev + 1, 4));
    }
  };

  const handleBack = () => {
    setCurrentStep(prev => Math.max(prev - 1, 1));
  };

  const handleSubmit = async () => {
    if (!validateStep(4)) return;

    setIsLoading(true);
    
    try {
      console.log('üöÄ Starting diagnosis submission...');
      
      // Âç≥Â∫ß„Å´ÂàÜÊûê‰∏≠ÁîªÈù¢„Å´ÁßªË°å
      setCurrentStep(4.5);
      setIsLoading(false);
      
      // WebhookÂæÖÊ©ü„ÇíÈñãÂßã
      startWaitingForWebhook();
      
      // Dify API„Å´ÈÄÅ‰ø°ÔºàÊàêÂäüÊôÇ„ÅØÁµêÊûú„Çí‰øùÂ≠ò„ÄÅÂ§±ÊïóÊôÇ„ÅØWebhook„Å´ÂÆåÂÖ®‰æùÂ≠òÔºâ
      let apiResult = null;
      try {
        apiResult = await submitDiagnosis(formData as FormData);
        console.log('üì§ Dify API response successful:', apiResult);
      } catch (apiError) {
        console.log('üì§ Dify API failed, relying completely on webhook:', apiError.message);
        // APIÂ§±ÊïóÊôÇ„ÅØWebhook„Å´„ÅÆ„Åø‰æùÂ≠ò
      }
      
      // Webhook„ÇíÂæÖÊ©ü‰∏≠„Åß„ÅÇ„Çã„Åì„Å®„Çí„É¶„Éº„Ç∂„Éº„Å´Ë°®Á§∫
      console.log('‚è≥ Waiting for Dify webhook result (primary source)...');
      
      // WebhookÁµêÊûú„ÇíÂæÖÊ©üÔºàAPI„ÅåÊàêÂäü„Åó„ÅüÂ†¥Âêà„ÅÆ„Åø„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
      const timeout = setTimeout(() => {
        console.log('‚è∞ Webhook timeout reached');
        
        if (apiResult) {
          console.log('üìã Using API result as fallback:', apiResult);
          setResults(apiResult);
          setCurrentStep(5);
          setIsLoading(false);
          setIsWaitingForWebhook(false);
        } else {
          console.log('‚ùå No API result available, showing error');
          setIsLoading(false);
          setIsWaitingForWebhook(false);
          alert('Ë®∫Êñ≠„ÅÆÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
      }, 15000); // 15Áßí„Å´Âª∂Èï∑„Åó„Å¶Webhook„ÇíÂÑ™ÂÖà

      // WebhookÂèó‰ø°ÊôÇ„Å´„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Çí„ÇØ„É™„Ç¢
      if (webhookResult) {
        clearTimeout(timeout);
        console.log('üéØ Webhook received, clearing timeout');
      }

    } catch (error) {
      console.error('‚ùå Submission error:', error);
      setIsLoading(false);
      setIsWaitingForWebhook(false);
      alert('Ë®∫Êñ≠„ÅÆÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }
  };

  const handleRestart = () => {
    setFormData({
      jobType: '',
      BusinessChallenge1: '',
      BusinessChallenge2: '',
      BusinessChallenge3: '',
      Q1: null, Q2: null, Q3: null, Q4: null, Q5: null, Q6: null, Q7: null, Q8: null, Q9: null, Q10: null,
      Q11: null, Q12: null, Q13: null, Q14: null, Q15: null, Q16: null, Q17: null, Q18: null, Q19: null, Q20: null,
      Q21: null, Q22: null, Q23: null, Q24: null, Q25: null, Q26: null, Q27: null, Q28: null, Q29: null, Q30: null,
      Q31: null, Q32: null, Q33: null, Q34: null, Q35: null,
      Q36: '', Q37: '', Q38: '', Q39: '', Q40: '',
      name: '',
      company: '',
      Yuryo: '',
      Muryo: '',
      Katsuyou: ''
    });
    setResults(null);
    setCurrentStep(1);
    setErrors({});
    setAgreedToTerms(false);
    setShowTermsStep(true);
    clearWebhookResult();
    localStorage.removeItem(STORAGE_KEY);
  };

  const handleStartDiagnosis = () => {
    setShowTermsStep(false);
    setCurrentStep(1);
  };

  const renderCurrentStep = () => {
    if (showTermsStep) {
      return (
        <TermsAgreement
          agreed={agreedToTerms}
          onAgreementChange={setAgreedToTerms}
          onStart={handleStartDiagnosis}
        />
      );
    }

    switch (currentStep) {
      case 1:
        return (
          <JobTypeSelection
            selectedJobType={formData.jobType || ''}
            onJobTypeChange={(jobType) => updateFormData('jobType', jobType)}
          />
        );
      case 2:
        return (
          <BusinessChallengeForm
            selectedJobType={formData.jobType || ''}
            challenges={{
              BusinessChallenge1: formData.BusinessChallenge1 || '',
              BusinessChallenge2: formData.BusinessChallenge2 || '',
              BusinessChallenge3: formData.BusinessChallenge3 || ''
            }}
            onChallengeUpdate={updateFormData}
          />
        );
      case 3:
        return (
          <AIQuestionsForm
            formData={formData}
            onAnswerChange={updateFormData}
          />
        );
      case 4:
        return (
          <PersonalInfoForm
            formData={{
              name: formData.name || '',
              company: formData.company || '',
              Yuryo: formData.Yuryo || '',
              Muryo: formData.Muryo || '',
              Katsuyou: formData.Katsuyou || ''
            }}
            onInfoChange={updateFormData}
          />
        );
      case 4.5:
        return <AnalysisLoading />;
      case 5:
        return (
          <ResultsDisplay
            results={results}
            onRestart={handleRestart}
          />
        );
      default:
        return null;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
      <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
        {/* „Éò„ÉÉ„ÉÄ„Éº */}
        <div className="text-center mb-8 sm:mb-12">
          <div className="flex items-center justify-center mb-4 sm:mb-6">
            {/* „É≠„Ç¥ÁîªÂÉè */}
            <div className="inline-flex items-center justify-center">
              <img 
                src="/screenshot-2025-06-18-15-32-55.png" 
                alt="AI „Éì„Ç∏„Éç„ÇπË®∫Êñ≠" 
                className="h-12 sm:h-16 md:h-20 w-auto"
              />
            </div>
          </div>
          <p className="text-base sm:text-lg md:text-xl text-slate-600 max-w-2xl mx-auto leading-relaxed px-2">
            „ÅÇ„Å™„Åü„ÅÆAIÊ¥ªÁî®„É¨„Éô„É´„ÇíË®∫Êñ≠„Åó„ÄÅÊúÄÈÅ©„Å™ÊîπÂñÑÊèêÊ°à„Çí„ÅäÂ±ä„Åë„Åó„Åæ„Åô
          </p>
        </div>

        {/* „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */}
        {!showTermsStep && currentStep <= 4 && (
          <StepIndicator currentStep={currentStep} totalSteps={4} />
        )}


        {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
        <div className="max-w-6xl mx-auto">
          <div className="bg-white rounded-2xl sm:rounded-3xl shadow-xl border border-slate-200 p-4 sm:p-6 md:p-8 min-h-[400px] sm:min-h-[600px]">
            {renderCurrentStep()}

            {/* „Ç®„É©„ÉºË°®Á§∫ */}
            {Object.keys(errors).length > 0 && (
              <div className="mt-8 p-6 bg-red-50 border border-red-200 rounded-2xl">
                <h4 className="text-red-800 font-semibold mb-3 flex items-center">
                  <span className="w-5 h-5 bg-red-500 rounded-full mr-2 flex items-center justify-center">
                    <span className="text-white text-xs">!</span>
                  </span>
                  ÂÖ•Âäõ„Ç®„É©„Éº
                </h4>
                <ul className="text-red-700 text-sm space-y-2">
                  {Object.values(errors).map((error, index) => (
                    <li key={index} className="flex items-center">
                      <span className="w-1.5 h-1.5 bg-red-400 rounded-full mr-3"></span>
                      {error}
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>

          {/* „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥ */}
          {!showTermsStep && currentStep <= 4 && currentStep !== 4.5 && (
            <div className="flex flex-col sm:flex-row justify-between gap-4 mt-6 sm:mt-8">
              <button
                onClick={handleBack}
                disabled={currentStep === 1}
                className={`
                  flex items-center justify-center px-6 sm:px-8 py-3 sm:py-4 font-semibold rounded-xl sm:rounded-2xl transition-all duration-300 transform text-sm sm:text-base
                  ${currentStep === 1
                    ? 'bg-slate-100 text-slate-400 cursor-not-allowed'
                    : 'bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 hover:shadow-lg hover:scale-105'
                  }
                `}
              >
                <ChevronLeft className="w-4 h-4 sm:w-5 sm:h-5 mr-2" />
                Êàª„Çã
              </button>

              {currentStep < 4 ? (
                <button
                  onClick={handleNext}
                  className="flex items-center justify-center px-6 sm:px-8 py-3 sm:py-4 bg-[#59B3B3] text-white font-semibold rounded-xl sm:rounded-2xl hover:bg-[#4A9999] transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl text-sm sm:text-base"
                >
                  Ê¨°„Å∏
                  <ChevronRight className="w-4 h-4 sm:w-5 sm:h-5 ml-2" />
                </button>
              ) : (
                <button
                  onClick={handleSubmit}
                  disabled={isLoading || isWaitingForWebhook}
                  className={`
                    flex items-center justify-center px-8 sm:px-10 py-3 sm:py-4 font-semibold rounded-xl sm:rounded-2xl transition-all duration-300 transform shadow-lg text-sm sm:text-base
                    ${isLoading || isWaitingForWebhook
                      ? 'bg-slate-400 text-white cursor-not-allowed'
                      : 'bg-[#59B3B3] text-white hover:bg-[#4A9999] hover:scale-105 hover:shadow-xl'
                    }
                  `}
                >
                  {isLoading || isWaitingForWebhook ? (
                    <>
                      <Loader2 className="w-4 h-4 sm:w-5 sm:h-5 mr-2 animate-spin" />
                      {isWaitingForWebhook ? 'AIÂàÜÊûê‰∏≠...' : 'ÈÄÅ‰ø°‰∏≠...'}
                    </>
                  ) : (
                    'Ë®∫Êñ≠ÂÆüË°å'
                  )}
                </button>
              )}
            </div>
          )}
        </div>

        {/* „Éï„ÉÉ„Çø„Éº */}
        <footer className="text-center mt-16 text-slate-500 text-sm">
          <div className="w-full h-px bg-slate-200 mb-6"></div>
          <p>¬©2025 anddigital Co.,Ltd</p>
        </footer>
      </div>
    </div>
  );
}

export default App;